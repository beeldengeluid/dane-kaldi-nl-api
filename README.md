# ASR API

**Note**: This repo is still work in progress and not fully optimised for convenient use.


This API is currently built on top of [Kaldi_NL](https://github.com/opensource-spraakherkenning-nl/Kaldi_NL) and supports both synchronous and asynchronous HTTP calls to invoke the processing of audiovisual files for obtaining speech transcripts (generated by ASR)

## Configuration

Make sure to create the central config file: `config/settings.yaml`. You can easily do this by copying the `config/settings_example.yaml` to `settings.yaml`

```yaml
DEBUG : bool = True

APP_HOST: '0.0.0.0'
APP_PORT: 3023

# relative from the server.py
BASE_FS_MOUNT_DIR: './mount' # /mnt/dane-fs when running in docker/k8s

#asr module settings (asr.py)
ASR_INPUT_DIR: 'input-files' # will be created in BASE_FS_MOUNT_DIR
ASR_OUTPUT_DIR: 'asr-output' # will be created in BASE_FS_MOUNT_DIR
ASR_PACKAGE_NAME: 'asr-features.tar.gz'
ASR_WORD_JSON_FILE: 'words.json'

#(as module) kaldi NL base dir and the decoder script therein
KALDI_NL_DIR: '/usr/local/opt/kaldi_nl' # without a local KaldiNL only simulation mode is possible
KALDI_NL_DECODER: 'decode_OH.sh'
KALDI_NL_MODEL_DIR: '/mnt/dane-fs/models'  # language models will be downloaded here
KALDI_NL_MODEL_FETCHER: 'entrypoint.sh'   # downloads language models

PID_CACHE_DIR: 'pid-cache' # relative from the server.py dir

LOG_DIR: "log" # relative from the server.py dir
LOG_NAME: "asr-service.log"
LOG_LEVEL_CONSOLE: "DEBUG" # Levels: NOTSET - DEBUG - INFO - WARNING - ERROR - CRITICAL
LOG_LEVEL_FILE: "DEBUG" # Levels: NOTSET - DEBUG - INFO - WARNING - ERROR - CRITICAL
```


## Building docker images

To properly build the docker image for this repo (working with the Oral History models only), first both images from the Kaldi_NL repo need to be built. After that it is recommended to register the built images (optimised for your own use) in a docker registry.

**Note**: at some point (this year 2022) we will provide prebuilt images (of different Kaldi_NL configurations) for the [CLARIAH](https://github.com/CLARIAH) organisation/project in an open registry. After that you can simply build the image with:

```bash
docker build -t dane-kaldi-nl-api -f Dockerfile .
```

### Kaldi and Kaldi_NL

(See [Kaldi_NL](https://github.com/opensource-spraakherkenning-nl/Kaldi_NL))

For the oral history (OH) decoder to be available, make sure to build in the following way:

```bash
git clone https://github.com/opensource-spraakherkenning-nl/Kaldi_NL.git
cd Kaldi_NL
docker build -t proycon/kaldi -f kaldi.Dockerfile .
docker build -t proycon/kaldi_nl --build-arg MODELPATH=/models --build-arg MODELS="utwente radboud_OH" .
```

Now to push the images to your registry:

```bash
docker tag procyon/kaldi {docker-registry}/proycon/kaldi:latest
docker push {docker-registry}/proycon/kaldi:latest
docker tag procyon/kaldi_nl {docker-registry}/proycon/kaldi_nl:latest
docker push {docker-registry}/proycon/kaldi_nl:latest
```

### dane-kaldi-nl-api (this repo)

If you have pushed the `proycon/kaldi_nl` image to your registry, you should update the `Dockerfile`:

```
FROM proycon/kaldi_nl:latest
```

Should become:

```
FROM {docker-registry}/proycon/kaldi_nl:latest
```

Build the image with:

```bash
docker build -t dane-kaldi-nl-api -f Dockerfile .
```

Now to push the image to your registry:

```bash

docker tag dane-kaldi-nl-api {docker-registry}/dane-kaldi-nl-api:latest
docker push {docker-registry}/dane-kaldi-nl-api:latest
```


## Running

The code for this repo is optimised to work with the [DANE ASR worker](https://github.com/beeldengeluid/dane-asr-worker) (not public yet).

Moreover running the code in this repo is optimised for docker and Kubernetes, but the Python code can still be run locally for development (by running `python server.py`).

Detailed instructions for Kubernetes and local development are pending.


